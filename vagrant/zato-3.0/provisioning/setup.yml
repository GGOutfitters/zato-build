---
# You can add users to the docker group to allow them to manage docker
# containers. This playbook uses sudo rather than the vagrant user because
# Ansible uses ControlPersist for SSH connections. The first time this playbook
# runs, the docker commands would fail if run by the vagrant user, since the
# persisted connection state isn't aware of the addition of the 'docker' group.

- name: General | Package Installation.
  apt: name={{ item }} state=present
  become: yes
  loop:
    - python-pip
    - git
    - apt-transport-https
    - curl
    - htop
    - libcurl4-openssl-dev
    - mc
    - redis-server
    - software-properties-common
    - ssh
    - sudo
    - supervisor
    - vim
    - tzdata
    - postgresql
    - postgresql-contrib
    - postgresql-client
    - python-psycopg2

- name: General | Add repository universe.
  command: add-apt-repository universe

# - name: General | Initiate database
#   command: initdb
#            creates=/var/lib/pgsql/data/postgresql.conf

- name: General | Start PostgreSQL and enable at boot
  service: name=postgresql
          enabled=yes
          state=started

- name: General | Ensure PostgreSQL is listening on all localhost
  lineinfile: dest=/var/lib/pgsql/data/postgresql.conf
     regexp='^#?listen_addresses\s*='
     line="listen_addresses = '127.0.0.1'"
     state=present
  notify: restart postgresql

- lineinfile: dest=/var/lib/pgsql/data/pg_hba.conf
           regexp='host\s+all\s+all\s+127.0.0.1/32\s+md5'
           line='host all all 127.0.0.1/32 md5'
           insertbefore=BOF
  notify: restart postgresql

- name: Zato | Add Zato's Apt signing key
  apt_key:
    url: https://zato.io/repo/zato-0CBD7F72.pgp.asc
    state: present

- name: Zato | Add Zato repository.
  apt_repository:
    repo: deb https://zato.io/repo/stable/3.0/ubuntu bionic main
    state: present
    filename: zato

- name: Zato | Zato package installation.
  apt: name=zato state=present
  become: yes

- name: Zato | Zato ODB database creation.
  postgresql_db:
    name: zato

- name: Zato | Create database user zato and grant access to database.
  postgresql_user:
    db: zato
    name: zato
    password: zato

- name: Start service redis, if not started
  service:
    name: redis-server
    state: started

- name: Start service postgresql, if not started
  service:
    name: httpd
    state: started

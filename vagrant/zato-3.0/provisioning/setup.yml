---

- name: General | Package Installation.
  apt: name={{ item }} state=present
  become: yes
  register: apt_res
  retries: 5
  until: apt_res is success
  loop:
    - python-pip
    - git
    - apt-transport-https
    - curl
    - htop
    - libcurl4-openssl-dev
    - mc
    - redis-server
    - software-properties-common
    - ssh
    - sudo
    - supervisor
    - vim
    - tzdata
    - postgresql
    - postgresql-contrib
    - postgresql-client
    - python-psycopg2

- name: General | Add repository universe.
  command: add-apt-repository universe

- name: General | Ensure PostgreSQL is listening on all localhost
  lineinfile: dest=/etc/postgresql/10/main/postgresql.conf
     regexp='^#?listen_addresses\s*='
     line="listen_addresses = '127.0.0.1'"
     state=present
  notify: restart postgresql

- name: Zato | Add Zato's Apt signing key
  apt_key:
    url: https://zato.io/repo/zato-0CBD7F72.pgp.asc
    state: present
  register: task_result
  until: task_result is succeeded
  retries: 10
  delay: 5

- name: Zato | Add Zato repository.
  apt_repository:
    repo: deb https://zato.io/repo/stable/3.0/ubuntu bionic main
    state: present
    filename: zato
  register: task_result
  until: task_result is succeeded
  retries: 10
  delay: 5

- name: Zato | Zato package installation.
  apt: name=zato state=present
  become: yes
  register: apt_res
  retries: 5
  until: apt_res is success

- name: Start service redis, if not started
  service:
    name: redis-server
    state: started
    enabled: yes

- name: Start service postgresql, if not started
  service:
    name: postgresql
    state: started
    enabled: yes

- name: Zato | Zato's global configuration
  shell: |
    set -x # enable show commands
    [[ -f /opt/zato-env.sh ]] && source /opt/zato-env.sh

    cd /opt/zato/
    if [[ -z "${ZATO_SSH_PASSWORD}" ]]; then
      if [[ -f /opt/zato/zato_user_password ]];then
        echo "Reading the password for zato user from the file"
        ZATO_SSH_PASSWORD="$(cat /opt/zato/zato_user_password)"
      else
        echo "Generating a password for zato user"
        ZATO_SSH_PASSWORD="$(uuidgen)"
      fi
    fi
    if [[ -z "${ZATO_WEB_ADMIN_PASSWORD}" ]]; then
      if [[ -f /opt/zato/zato_user_password ]];then
        echo "Reading the password for web admin from the file"
        ZATO_WEB_ADMIN_PASSWORD="$(cat /opt/zato/web_admin_password)"
      else
        echo "Generating a password for web admin"
        ZATO_WEB_ADMIN_PASSWORD="$(uuidgen)"
      fi
    fi

    echo "${ZATO_SSH_PASSWORD}" > /opt/zato/zato_user_password && \
    chown zato:zato /opt/zato/zato_user_password && \
    echo "zato:$(cat /opt/zato/zato_user_password)" > /opt/zato/change_zato_password && \
    chpasswd < /opt/zato/change_zato_password

    for i in update_password.config zato_start_load_balancer zato_start_scheduler zato_start_server1 zato_start_server2 zato_start_web_admin;do
      [[ -f $i ]] || wget -t 0 -T 10 -w 2 https://raw.githubusercontent.com/zatosource/zato-build/master/docker/quickstart/$i
    done
    chmod 755 \
      /opt/zato/zato_start_load_balancer \
      /opt/zato/zato_start_server1 \
      /opt/zato/zato_start_server2 \
      /opt/zato/zato_start_web_admin \
      /opt/zato/zato_start_scheduler || exit 1

    echo "${ZATO_WEB_ADMIN_PASSWORD}" > /opt/zato/web_admin_password
    echo "password=${ZATO_WEB_ADMIN_PASSWORD}" >> /opt/zato/update_password.config

    chown zato:zato /opt/zato/update_password.config || exit 1

    set -x # enable show commands
    exit 0
  args:
    executable: /bin/bash

- name: Zato | Create quickstart directory
  file: path=/opt/zato/env/qs-1/ owner=zato group=zato
        state=directory
  become: yes
  become_user: zato

- name: Zato | create quickstart
  shell: /opt/zato/current/bin/zato quickstart create \
         --odb_host "localhost" \
         --odb_port 5432 \
         --odb_user "zato" \
         --odb_db_name "zato" \
         --odb_password "{{ dbpassword }}" \
         --kvdb_password '' \
         /opt/zato/env/qs-1 postgresql localhost 6379
         --verbose
  become: yes
  become_user: zato
  register: quickstart

- name: Zato | Granting access to load-balancer
  replace:
   path: /opt/zato/env/qs-1/load-balancer/config/repo/zato.config
   regexp: '127\.0\.0\.1:11223'
   replace: '0.0.0.0:11223'
   backup: yes

- name: Zato | Reduce Workers in server1
  replace:
   path: /opt/zato/env/qs-1/server1/config/repo/server.conf
   regexp: 'gunicorn_workers=2'
   replace: 'gunicorn_workers=1'
   backup: yes

- name: Zato | Reduce Workers in server2
  replace:
   path: /opt/zato/env/qs-1/server2/config/repo/server.conf
   regexp: 'gunicorn_workers=2'
   replace: 'gunicorn_workers=1'
   backup: yes

- name: Zato | Copying Zato's supervisord config
  copy:
    src: provisioning/supervisord.conf
    dest: /etc/supervisor/conf.d/zato.conf
    mode: 0644
  notify: restart supervisor

- name: Start service supervisor, if not started
  service:
    name: supervisor
    state: started
    enabled: yes
